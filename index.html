<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Portfolio Analytics with Yahoo Finance</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1600px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #007AFF;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background-color: #f8f9ff;
            cursor: pointer;
        }
        .upload-area:hover {
            background-color: #e8f0ff;
        }
        button {
            background-color: #007AFF;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056CC;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .portfolio-config {
            background-color: #e8f5e8;
            border-left: 4px solid #28a745;
        }
        .analytics-section {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .price-section {
            background-color: #e8f4fd;
            border-left: 4px solid #007AFF;
        }
        .categorization-table, .price-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            max-height: 600px;
            overflow-y: auto;
            display: block;
            border: 1px solid #ddd;
        }
        .categorization-table thead, .price-table thead {
            display: table;
            width: 100%;
            table-layout: fixed;
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .categorization-table tbody, .price-table tbody {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        .categorization-table th, .categorization-table td,
        .price-table th, .price-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
            word-wrap: break-word;
        }
        .categorization-table select, .price-table input {
            width: 95%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .stock-row {
            background-color: white;
        }
        .stock-row:nth-child(even) {
            background-color: #fafafa;
        }
        .positive { color: #28a745; font-weight: bold; }
        .negative { color: #dc3545; font-weight: bold; }
        .neutral { color: #6c757d; }
        .portfolio-summary {
            background-color: #f0f9ff;
            border: 2px solid #007AFF;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .portfolio-item {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
        #fileInput, #priceFileInput {
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .account-summary {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            padding: 10px;
            margin: 15px 0;
        }
        .filter-controls {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-controls select, .filter-controls input {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .kpi-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .kpi-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #007AFF;
        }
        .kpi-label {
            color: #666;
            margin-top: 10px;
        }
        .storage-status {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .snapshot-controls {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 10px 15px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            font-size: 14px;
        }
        .nav-tab.active {
            background: white;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .credit-input {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .metric-value {
            font-size: 1.6em;
            font-weight: bold;
            margin: 10px 0;
        }
        .price-update-controls {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="background: #007AFF; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; font-weight: bold; font-size: 18px;">
            üåê YAHOO FINANCE INTEGRATED: Complete Portfolio Analytics v5.0 üåê
        </div>
        <h1>Advanced Portfolio Analytics with Yahoo Finance</h1>
        <p>Complete portfolio management with live Yahoo Finance prices, performance metrics, risk analysis, and credit management.</p>

```
    <!-- Storage Status -->
    <div class="storage-status" id="storageStatus">
        <strong>Storage Status:</strong> <span id="storageStatusText">Initializing...</span>
    </div>

    <!-- Credit Outstanding Input -->
    <div class="credit-input">
        <h4>Credit Management</h4>
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <label>Current Credit Outstanding: 
                <input type="number" id="creditOutstanding" placeholder="Enter current credit amount" step="0.01" onchange="saveCreditAmount()">
            </label>
            <label>Currency: 
                <select id="creditCurrency" onchange="saveCreditAmount()">
                    <option value="SEK">SEK</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="DKK">DKK</option>
                    <option value="NOK">NOK</option>
                </select>
            </label>
            <div id="creditStatus" style="font-weight: bold;"></div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="showTab('setup')">Setup & Import</div>
        <div class="nav-tab" onclick="showTab('prices')">Price Management</div>
        <div class="nav-tab" onclick="showTab('analytics')">Analytics</div>
        <div class="nav-tab" onclick="showTab('performance')">Performance & Risk</div>
        <div class="nav-tab" onclick="showTab('history')">Historical Data</div>
    </div>

    <!-- Setup Tab -->
    <div id="setup" class="tab-content active">
        <!-- Portfolio Configuration -->
        <div class="section portfolio-config" id="portfolioConfig">
            <h3>Portfolio Configuration</h3>
            <p>Define your portfolio categories:</p>
            
            <div class="input-group">
                <label>Add New Portfolio Category:</label>
                <input type="text" id="newPortfolioName" placeholder="e.g., Large Cap, Small Cap, Growth, Value, etc.">
                <button onclick="addPortfolioCategory()" style="margin-left: 10px;">Add Category</button>
            </div>
            
            <div id="portfolioList">
                <!-- Default portfolios will be added here -->
            </div>
        </div>

        <!-- File Upload -->
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <h3>Upload CSV File</h3>
            <p>Drop your broker CSV file here or click to browse<br>
            <small>Expected format: Account Number, Stock Symbol, Company Name, Volume, etc.</small></p>
            <input type="file" id="fileInput" accept=".csv" onchange="handleFileSelect(event)">
        </div>

        <!-- Account Summary -->
        <div class="section" id="accountSummary" style="display: none;">
            <h3>Import Summary</h3>
            <div id="accountSummaryContent"></div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls" id="filterControls" style="display: none;">
            <label>Filter by Account: 
                <select id="accountFilter" onchange="applyFilters()">
                    <option value="">All Accounts</option>
                </select>
            </label>
            <label>Filter by Portfolio: 
                <select id="portfolioFilter" onchange="applyFilters()">
                    <option value="">All Portfolios</option>
                </select>
            </label>
            <label>Search Stock: 
                <input type="text" id="stockSearch" placeholder="Search by symbol or name" onkeyup="applyFilters()">
            </label>
            <button onclick="clearFilters()">Clear Filters</button>
        </div>

        <!-- Stock Categorization -->
        <div class="section" id="categorizationSection" style="display: none;">
            <h3>Account/Stock Categorization</h3>
            <p>Assign each account/stock combination to a portfolio category:</p>
            
            <table class="categorization-table" id="categorizationTable">
                <thead>
                    <tr>
                        <th style="width: 12%;">Account</th>
                        <th style="width: 15%;">Yahoo Ticker</th>
                        <th style="width: 18%;">Company</th>
                        <th style="width: 12%;">Shares</th>
                        <th style="width: 18%;">Portfolio</th>
                        <th style="width: 25%;">Notes</th>
                    </tr>
                </thead>
                <tbody id="categorizationTableBody">
                </tbody>
            </table>
            
            <div style="margin-top: 15px;">
                <button onclick="savePortfolioData()" id="saveBtn" style="background-color: #28a745;">Save Portfolio Data</button>
                <button onclick="bulkAssign()" style="background-color: #6c757d;">Bulk Assign Selected</button>
                <button onclick="generatePortfolioReport()" id="generateBtn">Generate Portfolio Report</button>
            </div>
        </div>

        <!-- Portfolio Summary -->
        <div class="section" id="portfolioSummary" style="display: none;">
            <h3>Portfolio Summary</h3>
            <div id="portfolioResults"></div>
            <div class="snapshot-controls">
                <h4>Create Portfolio Snapshot</h4>
                <p>Save current portfolio state for historical tracking:</p>
                <button onclick="createPortfolioSnapshot()" style="background-color: #17a2b8;">Create Snapshot</button>
                <button onclick="exportPortfolioData()" style="background-color: #28a745;">Export Portfolio Data</button>
            </div>
        </div>
    </div>

    <!-- Price Management Tab -->
    <div id="prices" class="tab-content">
        <div class="section price-section">
            <h3>Stock Price Management with Yahoo Finance</h3>
            <p>Automatic and manual stock price management for portfolio valuation:</p>
            
            <div class="price-update-controls">
                <h4>Yahoo Finance Integration</h4>
                <button onclick="fetchAllPricesFromYahoo()" style="background-color: #28a745;">üîÑ Fetch All Prices from Yahoo Finance</button>
                <button onclick="showPriceTable()">Manual Price Entry</button>
                <button onclick="bulkPriceUpdate()" style="background-color: #6c757d;">Bulk Update Prices</button>
                <button onclick="exportPriceTemplate()" style="background-color: #6c757d;">Export Price Template</button>
                <input type="file" id="priceFileInput" accept=".csv" onchange="importPrices(event)">
                <button onclick="document.getElementById('priceFileInput').click()" style="background-color: #17a2b8;">Import Prices from CSV</button>
                
                <div style="margin-top: 15px; padding: 10px; background-color: #e8f4fd; border-radius: 5px;">
                    <h5>Yahoo Finance Status</h5>
                    <p><strong>Status:</strong> <span id="yahooStatus">Ready</span></p>
                    <p><strong>Last Update:</strong> <span id="lastYahooUpdate">Never</span></p>
                    <label>
                        <input type="checkbox" id="autoUpdatePrices" onchange="toggleAutoUpdate()"> 
                        Auto-update prices on page load (every 4+ hours)
                    </label>
                </div>
            </div>

            <div id="priceTableSection" style="display: none;">
                <table class="price-table" id="priceTable">
                    <thead>
                        <tr>
                            <th style="width: 18%;">Ticker</th>
                            <th style="width: 22%;">Company</th>
                            <th style="width: 18%;">Current Price</th>
                            <th style="width: 15%;">Purchase Price</th>
                            <th style="width: 12%;">Currency</th>
                            <th style="width: 15%;">Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="priceTableBody">
                    </tbody>
                </table>
                <button onclick="savePrices()" style="background-color: #28a745;">Save All Prices</button>
            </div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
        <div class="section analytics-section">
            <h3>Portfolio Analytics Dashboard</h3>
            <div class="analytics-grid" id="analyticsGrid">
                <!-- KPI cards will be populated here -->
            </div>
            <div id="portfolioAnalytics">
                <!-- Detailed analytics will go here -->
            </div>
        </div>
    </div>

    <!-- Performance & Risk Tab -->
    <div id="performance" class="tab-content">
        <div class="section">
            <h3>Performance & Risk Analysis</h3>
            <div class="analytics-grid" id="performanceGrid">
                <!-- Performance metrics will be populated here -->
            </div>
            <div id="riskAnalytics">
                <!-- Risk analysis will go here -->
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div id="history" class="tab-content">
        <div class="section">
            <h3>Historical Data</h3>
            <div id="historyContent">
                <p>Historical snapshots and performance tracking will be displayed here.</p>
                <button onclick="loadHistoricalData()">Load Historical Data</button>
                <div id="historicalSummary"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let csvData = [];
    let portfolioCategories = [];
    let categorizedStocks = [];
    let portfolioAssignments = {};
    let accounts = {};
    let filteredData = [];
    let portfolioSnapshots = [];
    let stockPrices = {};
    let creditOutstanding = 0;
    let creditCurrency = 'SEK';
    let isUpdatingPrices = false;
    let autoUpdateEnabled = false;

    // Symbol mappings
    const symbolMappings = {
        'INVE B': 'INVE-B.ST', 'NOVO B': 'NOVO-B.CO', 'RMSp': 'RMS.PA', 'AAK': 'AAK.ST',
        'SWED A': 'SWED-A.ST', 'VOLV B': 'VOLV-B.ST', 'SKF B': 'SKF-B.ST', '8TRA': '8TRA.ST',
        'SEB A': 'SEB-A.ST', 'NDA SE': 'NDA-SE.ST', 'SHB A': 'SHB-A.ST', 'DANSKE': 'DANSKE.CO',
        'ESSITY B': 'ESSITY-B.ST', 'HEXA B': 'HEXA-B.ST', 'INDU C': 'INDU-C.ST', 'IVGm': 'IVG.MI',
        'BOL': 'BOL.ST', 'SECU B': 'SECU-B.ST', 'ATCO A': 'ATCO-A.ST', 'ATCO B': 'ATCO-B.ST',
        'AZN': 'AZN.ST', 'CAMX': 'CAMX.ST', 'ABB': 'ABB.ST', 'ALFA': 'ALFA.ST', 'EPI B': 'EPI-B.ST',
        'INVE A': 'INVE-A.ST', 'ASMLa': 'ASML.AS', 'MSFT': 'MSFT', 'MCp': 'MC.PA', 'V': 'V',
        'ABBV': 'ABBV', 'JPM': 'JPM', 'PG': 'PG'
    };

    // Yahoo Finance API integration
    async function fetchStockPrice(ticker) {
        try {
            // Use a CORS proxy to access Yahoo Finance API
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}`;
            const url = proxyUrl + encodeURIComponent(yahooUrl);
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.chart && data.chart.result && data.chart.result.length > 0) {
                const result = data.chart.result[0];
                const currentPrice = result.meta.regularMarketPrice;
                const currency = result.meta.currency;
                
                return {
                    price: currentPrice,
                    currency: currency.toUpperCase(),
                    success: true
                };
            } else {
                throw new Error('No price data found');
            }
        } catch (error) {
            console.error(`Error fetching price for ${ticker}:`, error);
            return {
                price: null,
                currency: null,
                success: false,
                error: error.message
            };
        }
    }

    async function fetchAllPricesFromYahoo() {
        if (isUpdatingPrices) {
            alert('Price update already in progress. Please wait...');
            return;
        }

        const uniqueTickers = [...new Set(csvData.map(item => item.yahooTicker))];
        if (uniqueTickers.length === 0) {
            alert('No stocks to update. Please import your portfolio first.');
            return;
        }

        isUpdatingPrices = true;
        document.getElementById('yahooStatus').textContent = 'Updating prices...';
        
        let successCount = 0;
        let failCount = 0;
        const errors = [];

        try {
            // Update prices in batches to avoid overwhelming the API
            const batchSize = 5;
            for (let i = 0; i < uniqueTickers.length; i += batchSize) {
                const batch = uniqueTickers.slice(i, i + batchSize);
                
                // Update status
                document.getElementById('yahooStatus').textContent = 
                    `Updating ${i + 1}-${Math.min(i + batchSize, uniqueTickers.length)} of ${uniqueTickers.length}...`;
                
                // Process batch in parallel
                const promises = batch.map(ticker => fetchStockPrice(ticker));
                const results = await Promise.all(promises);
                
                // Update stock prices with results
                results.forEach((result, index) => {
                    const ticker = batch[index];
                    
                    if (!stockPrices[ticker]) {
                        stockPrices[ticker] = {};
                    }
                    
                    if (result.success) {
                        stockPrices[ticker].currentPrice = result.price;
                        stockPrices[ticker].currency = result.currency;
                        stockPrices[ticker].lastUpdated = new Date().toISOString();
                        stockPrices[ticker].source = 'Yahoo Finance';
                        successCount++;
                    } else {
                        failCount++;
                        errors.push(`${ticker}: ${result.error}`);
                    }
                });
                
                // Small delay between batches to be respectful to the API
                if (i + batchSize < uniqueTickers.length) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            // Save updated prices
            saveStockPrices();
            
            // Update display
            if (document.getElementById('priceTableSection').style.display === 'block') {
                displayPriceTable();
            }
            
            // Update status
            const now = new Date().toLocaleString();
            document.getElementById('yahooStatus').textContent = 
                `Completed: ${successCount} updated, ${failCount} failed`;
            document.getElementById('lastYahooUpdate').textContent = now;
            localStorage.setItem('lastYahooUpdate', now);
            
            // Show results
            let message = `Price update completed!\n\n`;
            message += `‚úÖ Successfully updated: ${successCount} stocks\n`;
            if (failCount > 0) {
                message += `‚ùå Failed to update: ${failCount} stocks\n\n`;
                if (errors.length > 0) {
                    message += `Errors:\n${errors.slice(0, 5).join('\n')}`;
                    if (errors.length > 5) {
                        message += `\n... and ${errors.length - 5} more`;
                    }
                }
            }
            
            alert(message);
            
        } catch (error) {
            console.error('Error updating prices:', error);
            document.getElementById('yahooStatus').textContent = 'Update failed';
            alert('Error updating prices: ' + error.message);
        } finally {
            isUpdatingPrices = false;
        }
    }

    async function fetchSingleStockPrice(ticker, displayElement) {
        try {
            displayElement.textContent = 'Updating...';
            const result = await fetchStockPrice(ticker);
            
            if (result.success) {
                if (!stockPrices[ticker]) {
                    stockPrices[ticker] = {};
                }
                stockPrices[ticker].currentPrice = result.price;
                stockPrices[ticker].currency = result.currency;
                stockPrices[ticker].lastUpdated = new Date().toISOString();
                stockPrices[ticker].source = 'Yahoo Finance';
                
                saveStockPrices();
                displayPriceTable();
                displayElement.textContent = 'Updated!';
                setTimeout(() => {
                    displayElement.textContent = 'Update';
                }, 2000);
            } else {
                displayElement.textContent = 'Failed';
                setTimeout(() => {
                    displayElement.textContent = 'Update';
                }, 2000);
            }
        } catch (error) {
            console.error('Error fetching price:', error);
            displayElement.textContent = 'Error';
            setTimeout(() => {
                displayElement.textContent = 'Update';
            }, 2000);
        }
    }

    function toggleAutoUpdate() {
        const checkbox = document.getElementById('autoUpdatePrices');
        autoUpdateEnabled = checkbox.checked;
        localStorage.setItem('autoUpdatePrices', autoUpdateEnabled.toString());
        
        if (autoUpdateEnabled) {
            alert('Auto-update enabled! Prices will be updated automatically when you load the page (if last update was more than 4 hours ago).');
        } else {
            alert('Auto-update disabled.');
        }
    }

    function loadAutoUpdateSetting() {
        try {
            const saved = localStorage.getItem('autoUpdatePrices');
            const lastUpdate = localStorage.getItem('lastYahooUpdate');
            
            if (saved === 'true') {
                autoUpdateEnabled = true;
                document.getElementById('autoUpdatePrices').checked = true;
            }
            
            if (lastUpdate) {
                document.getElementById('lastYahooUpdate').textContent = lastUpdate;
            }
        } catch (error) {
            console.error('Error loading auto-update setting:', error);
        }
    }

    async function autoUpdatePricesIfEnabled() {
        if (autoUpdateEnabled && csvData.length > 0) {
            // Check if we updated recently (within last 4 hours)
            const lastUpdate = localStorage.getItem('lastYahooUpdate');
            if (lastUpdate) {
                const lastUpdateTime = new Date(lastUpdate);
                const now = new Date();
                const hoursSinceUpdate = (now - lastUpdateTime) / (1000 * 60 * 60);
                
                if (hoursSinceUpdate < 4) {
                    document.getElementById('yahooStatus').textContent = 
                        `Skipped auto-update (last update: ${hoursSinceUpdate.toFixed(1)}h ago)`;
                    return;
                }
            }
            
            // Auto-update prices
            console.log('Auto-updating prices...');
            await fetchAllPricesFromYahoo();
        }
    }

    // Initialize storage
    function initStorage() {
        console.log('Starting storage initialization...');
        
        try {
            const testKey = 'portfolio_test';
            localStorage.setItem(testKey, 'test');
            localStorage.removeItem(testKey);
            
            document.getElementById('storageStatusText').textContent = 'Local storage ready';
            
            loadPortfolioCategories();
            loadPortfolioData();
            loadSnapshots();
            loadStockPrices();
            loadCreditData();
            loadAutoUpdateSetting();
            
            // Auto-update prices if enabled (delayed to avoid blocking)
            setTimeout(() => {
                autoUpdatePricesIfEnabled();
            }, 3000);
```
