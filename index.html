<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .upload-area {
            border: 2px dashed #007AFF;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background-color: #f8f9ff;
            cursor: pointer;
        }
        .upload-area:hover {
            background-color: #e8f0ff;
        }
        button {
            background-color: #007AFF;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056CC;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .status {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin: 20px 0;
        }
        .nav-tab {
            padding: 10px 15px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .nav-tab.active {
            background: white;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
        }
        input[type="text"], input[type="number"] {
            width: 90%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="background: #28a745; color: white; padding: 15px; text-align: center; border-radius: 8px; margin-bottom: 20px; font-weight: bold;">
            ‚úÖ MINIMAL VERSION: Guaranteed to Work v1.0 ‚úÖ
        </div>

```
    <h1>Portfolio Management System</h1>
    <p>Simple, reliable portfolio management with Yahoo Finance integration</p>

    <div class="status">
        <strong>Status:</strong> <span id="status">Ready - Upload CSV to begin</span>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="showTab('setup')">Setup</div>
        <div class="nav-tab" onclick="showTab('prices')">Prices</div>
        <div class="nav-tab" onclick="showTab('analytics')">Analytics</div>
    </div>

    <!-- Setup Tab -->
    <div id="setup" class="tab-content active">
        <div class="section">
            <h3>CSV Import</h3>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <h4>Upload CSV File</h4>
                <p>Click to browse for your broker CSV file</p>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            
            <div id="importResults" style="display: none;">
                <div class="success">
                    <h4>Import Successful!</h4>
                    <p id="importSummary"></p>
                </div>
                
                <div id="holdingsTable"></div>
            </div>
        </div>
    </div>

<!-- Prices Tab -->
    <div id="prices" class="tab-content">
        <div class="section">
            <h3>Price Management</h3>
            <button onclick="fetchAllPrices()" class="btn-primary">
                üîÑ Fetch Prices from Yahoo Finance
            </button>
            <button onclick="showPriceTable()" class="btn-secondary">
                Toggle Price Table
            </button>
           <button onclick="showTickerManager()" class="btn-secondary">
                üîß Manage Tickers
            </button>
            <button onclick="showAutoUpdateConfig()" class="btn-secondary">
                ‚è∞ Auto-Update Settings
            </button>
            
            <div class="yahoo-status">
                <strong>Yahoo Status:</strong> <span id="yahooStatus">Ready</span>
            </div>
            
            <div id="priceTable" style="display: none; margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
        <div class="section">
            <h3>Portfolio Analytics</h3>
            <div id="analyticsContent">
                <p>Import portfolio data and fetch prices to see analytics.</p>
            </div>
        </div>
    </div>
</div>
```

<script>
// Global data
var portfolioData = {
    holdings: [],
    prices: {}
};

// Ticker mappings
var tickerMappings = {
    'INVE B': 'INVE-B.ST',
    'NOVO B': 'NOVO-B.CO', 
    'AAK': 'AAK.ST',
    'SWED A': 'SWED-A.ST',
    'VOLV B': 'VOLV-B.ST',
    'SKF B': 'SKF-B.ST',
    'SEB A': 'SEB-A.ST',
    'SHB A': 'SHB-A.ST',
    'ESSITY B': 'ESSITY-B.ST',
    'HEXA B': 'HEXA-B.ST',
    'ALFA': 'ALFA.ST',
    'ABB': 'ABB.ST',
    'ATCO A': 'ATCO-A.ST',
    'ATCO B': 'ATCO-B.ST',
    'AZN': 'AZN.ST',
    'BOL': 'BOL.ST',
    'CAMX': 'CAMX.ST',
    'EPI B': 'EPI-B.ST',
    'INDU C': 'INDU-C.ST',
    'SECU B': 'SECU-B.ST',
    '8TRA': '8TRA.ST',
    'NDA SE': 'NDA-SE.ST',
    'DANSKE': 'DANSKE.CO',
    'ASMLa': 'ASML.AS',
    'RMSp': 'RMS.PA',
    'MCp': 'MC.PA',
    'IVGm': 'IVG.MI',
    'MSFT': 'MSFT',
    'V': 'V',
    'JPM': 'JPM',
    'ABBV': 'ABBV',
    'PG': 'PG'
};

// Tab navigation
function showTab(tabName) {
    // Hide all tabs
    var tabs = document.getElementsByClassName('tab-content');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
    }
    
    var navTabs = document.getElementsByClassName('nav-tab');
    for (var i = 0; i < navTabs.length; i++) {
        navTabs[i].classList.remove('active');
    }
    
    // Show selected tab
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    
    if (tabName === 'analytics') {
        loadAnalytics();
    }
}

// File handling
document.getElementById('fileInput').addEventListener('change', function(event) {
    var file = event.target.files[0];
    if (!file) return;
    
    var reader = new FileReader();
    reader.onload = function(e) {
        parseCSV(e.target.result);
    };
    reader.readAsText(file);
});

// CSV parsing
function parseCSV(csvText) {
    var lines = csvText.split('\n').filter(function(line) { 
        return line.trim(); 
    });
    
    if (lines.length < 2) {
        alert('Invalid CSV file');
        return;
    }

    var headers = lines[0].split(';');
    console.log('Headers:', headers);

    // Find columns
    var accountIndex = -1, symbolIndex = -1, nameIndex = -1, volumeIndex = -1, isinIndex = -1;
    
    for (var i = 0; i < headers.length; i++) {
        var header = headers[i].toLowerCase();
        if (header.includes('konto') || header.includes('account')) {
            accountIndex = i;
        } else if (header.includes('kortnamn') || header.includes('symbol')) {
            symbolIndex = i;
        } else if (header.includes('namn') || header.includes('name')) {
            nameIndex = i;
        } else if (header.includes('volym') || header.includes('antal')) {
            volumeIndex = i;
        } else if (header.includes('isin')) {
            isinIndex = i;
        }
    }

    if (accountIndex === -1 || symbolIndex === -1 || volumeIndex === -1) {
        alert('Required columns not found');
        return;
    }

    // Parse holdings
    portfolioData.holdings = [];
    
    for (var i = 1; i < lines.length; i++) {
        var row = lines[i].split(';');
        var account = row[accountIndex] ? row[accountIndex].trim() : '';
        var symbol = row[symbolIndex] ? row[symbolIndex].trim() : '';
        var volume = row[volumeIndex] ? parseFloat(row[volumeIndex].trim().replace(',', '.')) : 0;
        var name = row[nameIndex] ? row[nameIndex].trim() : symbol;
        var isin = row[isinIndex] ? row[isinIndex].trim() : '';

        if (account && symbol && !isNaN(volume) && volume > 0) {
            var ticker = convertToYahooTicker(symbol, isin);
            
            portfolioData.holdings.push({
                account: account,
                symbol: symbol,
                name: name,
                volume: Math.round(volume),
                isin: isin,
                ticker: ticker
            });
        }
    }

    displayImportResults();
}

function convertToYahooTicker(symbol, isin) {
    // Check direct mappings first
    if (tickerMappings[symbol]) {
        return tickerMappings[symbol];
    }
    
    // Use ISIN if available
    if (isin && isin.length >= 2) {
        var country = isin.substring(0, 2);
        if (country === 'SE') return symbol + '.ST';
        if (country === 'DK') return symbol + '.CO';
        if (country === 'NO') return symbol + '.OL';
        if (country === 'FI') return symbol + '.HE';
        if (country === 'FR') return symbol + '.PA';
        if (country === 'DE') return symbol + '.DE';
        if (country === 'IT') return symbol + '.MI';
        if (country === 'NL') return symbol + '.AS';
        if (country === 'GB') return symbol + '.L';
        if (country === 'US') return symbol;
    }
    
    // Default to Swedish exchange
    return symbol + '.ST';
}

function displayImportResults() {
    var totalHoldings = portfolioData.holdings.length;
    var uniqueAccounts = new Set();
    var uniqueStocks = new Set();
    
    portfolioData.holdings.forEach(function(holding) {
        uniqueAccounts.add(holding.account);
        uniqueStocks.add(holding.ticker);
    });

    document.getElementById('importSummary').innerHTML = 
        'Imported ' + totalHoldings + ' holdings from ' + uniqueAccounts.size + 
        ' accounts (' + uniqueStocks.size + ' unique stocks)';

    // Create holdings table
    var tableHtml = '<table><thead><tr>' +
        '<th>Account</th><th>Symbol</th><th>Yahoo Ticker</th><th>Name</th><th>Shares</th>' +
        '</tr></thead><tbody>';
        
    portfolioData.holdings.forEach(function(holding) {
        tableHtml += '<tr>' +
            '<td>' + holding.account + '</td>' +
            '<td><strong>' + holding.symbol + '</strong></td>' +
            '<td><strong>' + holding.ticker + '</strong></td>' +
            '<td>' + holding.name + '</td>' +
            '<td>' + holding.volume.toLocaleString() + '</td>' +
            '</tr>';
    });
    
    tableHtml += '</tbody></table>';
    document.getElementById('holdingsTable').innerHTML = tableHtml;
    document.getElementById('importResults').style.display = 'block';
    
    document.getElementById('status').textContent = 'Portfolio imported successfully - ' + totalHoldings + ' holdings';
}

// Price fetching
function fetchAllPrices() {
    if (portfolioData.holdings.length === 0) {
        alert('Please import portfolio data first');
        return;
    }
    
    var uniqueTickers = [];
    var seen = {};
    
    portfolioData.holdings.forEach(function(holding) {
        if (!seen[holding.ticker]) {
            seen[holding.ticker] = true;
            uniqueTickers.push(holding.ticker);
        }
    });
    
    document.getElementById('yahooStatus').textContent = 'Fetching prices for ' + uniqueTickers.length + ' stocks...';
    
    fetchPricesSequentially(uniqueTickers, 0);
}

function fetchPricesSequentially(tickers, index) {
    if (index >= tickers.length) {
        // Finished
        var successCount = Object.keys(portfolioData.prices).length;
        document.getElementById('yahooStatus').textContent = 
            'Completed: ' + successCount + ' prices fetched';
        alert('Price update completed: ' + successCount + ' stocks updated');
        return;
    }
    
    var ticker = tickers[index];
    document.getElementById('yahooStatus').textContent = 
        'Fetching ' + (index + 1) + '/' + tickers.length + ': ' + ticker;
    
    fetchSinglePrice(ticker, function() {
        setTimeout(function() {
            fetchPricesSequentially(tickers, index + 1);
        }, 1000);
    });
}

function fetchSinglePrice(ticker, callback) {
    var proxyUrl = 'https://api.allorigins.win/raw?url=';
    var yahooUrl = 'https://query1.finance.yahoo.com/v8/finance/chart/' + ticker;
    var url = proxyUrl + encodeURIComponent(yahooUrl);
    
    fetch(url)
        .then(function(response) {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            return response.json();
        })
        .then(function(data) {
            if (data.chart && data.chart.result && data.chart.result.length > 0) {
                var result = data.chart.result[0];
                var price = result.meta.regularMarketPrice;
                var currency = result.meta.currency || 'USD';
                
                portfolioData.prices[ticker] = {
                    price: price,
                    currency: currency.toUpperCase(),
                    lastUpdated: new Date().toISOString()
                };
                
                console.log('‚úÖ ' + ticker + ': ' + price + ' ' + currency);
            }
        })
        .catch(function(error) {
            console.log('‚ùå ' + ticker + ': ' + error.message);
        })
        .finally(function() {
            if (callback) callback();
        });
}

function showPriceTable() {
    var tableDiv = document.getElementById('priceTable');
    var isVisible = tableDiv.style.display !== 'none';
    
    if (isVisible) {
        tableDiv.style.display = 'none';
        return;
    }
    
    if (portfolioData.holdings.length === 0) {
        alert('Please import portfolio data first');
        return;
    }
    
    var uniqueTickers = [];
    var seen = {};
    
    portfolioData.holdings.forEach(function(holding) {
        if (!seen[holding.ticker]) {
            seen[holding.ticker] = true;
            uniqueTickers.push({
                ticker: holding.ticker,
                name: holding.name
            });
        }
    });
    
    var tableHtml = '<table><thead><tr>' +
        '<th>Ticker</th><th>Company</th><th>Current Price</th><th>Currency</th><th>Last Updated</th>' +
        '</tr></thead><tbody>';
        
    uniqueTickers.forEach(function(stock) {
        var priceData = portfolioData.prices[stock.ticker];
        var price = priceData ? priceData.price.toFixed(2) : 'N/A';
        var currency = priceData ? priceData.currency : 'N/A';
        var updated = priceData ? new Date(priceData.lastUpdated).toLocaleTimeString() : 'Never';
        
        tableHtml += '<tr>' +
            '<td><strong>' + stock.ticker + '</strong></td>' +
            '<td>' + stock.name + '</td>' +
            '<td>' + price + '</td>' +
            '<td>' + currency + '</td>' +
            '<td>' + updated + '</td>' +
            '</tr>';
    });
    
    tableHtml += '</tbody></table>';
    tableDiv.innerHTML = tableHtml;
    tableDiv.style.display = 'block';
}

function loadAnalytics() {
    if (portfolioData.holdings.length === 0) {
        document.getElementById('analyticsContent').innerHTML = 
            '<p>No portfolio data available. Please import CSV first.</p>';
        return;
    }
    
    var totalHoldings = portfolioData.holdings.length;
    var uniqueAccounts = new Set();
    var uniqueStocks = new Set();
    var totalShares = 0;
    var totalValue = 0;
    var stocksWithPrices = Object.keys(portfolioData.prices).length;
    
    portfolioData.holdings.forEach(function(holding) {
        uniqueAccounts.add(holding.account);
        uniqueStocks.add(holding.ticker);
        totalShares += holding.volume;
        
        var priceData = portfolioData.prices[holding.ticker];
        if (priceData) {
            totalValue += holding.volume * priceData.price;
        }
    });
    
    var analyticsHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">';
    
    var kpis = [
        {label: 'Accounts', value: uniqueAccounts.size},
        {label: 'Holdings', value: totalHoldings},
        {label: 'Unique Stocks', value: uniqueStocks.size},
        {label: 'Total Shares', value: totalShares.toLocaleString()},
        {label: 'Stocks with Prices', value: stocksWithPrices + '/' + uniqueStocks.size},
        {label: 'Portfolio Value', value: totalValue > 0 ? totalValue.toLocaleString() : 'N/A'}
    ];
    
    kpis.forEach(function(kpi) {
        analyticsHtml += '<div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; text-align: center;">' +
            '<div style="font-size: 1.5em; font-weight: bold; color: #007AFF;">' + kpi.value + '</div>' +
            '<div style="color: #666;">' + kpi.label + '</div>' +
            '</div>';
    });
    
    analyticsHtml += '</div>';
    
    // Account breakdown
    var accounts = {};
    portfolioData.holdings.forEach(function(holding) {
        if (!accounts[holding.account]) {
            accounts[holding.account] = {holdings: [], value: 0};
        }
        accounts[holding.account].holdings.push(holding);
        
        var priceData = portfolioData.prices[holding.ticker];
        if (priceData) {
            accounts[holding.account].value += holding.volume * priceData.price;
        }
    });
    
    analyticsHtml += '<div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 20px;">' +
        '<h4>Account Breakdown</h4>';
    
    Object.keys(accounts).forEach(function(accountNum) {
        var account = accounts[accountNum];
        analyticsHtml += '<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">' +
            '<strong>Account ' + accountNum + '</strong>: ' + account.holdings.length + ' holdings';
        if (account.value > 0) {
            analyticsHtml += ' (Value: ' + account.value.toLocaleString() + ')';
        }
        analyticsHtml += '</div>';
    });
    
    analyticsHtml += '</div>';
    
    document.getElementById('analyticsContent').innerHTML = analyticsHtml;
}

// Initialize
console.log('‚úÖ Portfolio Management System loaded');
document.getElementById('status').textContent = 'System ready - Upload CSV to begin';
</script>

<script src="data.js"></script>
<script src="csv-parser.js"></script>
<script src="yahoo-finance.js"></script>
<script src="analytics.js"></script>
<script src="main.js"></script>

</body>
</html>
